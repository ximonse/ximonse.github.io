<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spatial Notes - Sök och Klunga</title>

    <!-- External dependencies -->
    <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <!-- Application styles -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="toolbar">
        <!-- Mobile hamburger toggle (hidden on desktop) -->
        <button class="toolbar-btn mobile-only" id="mobileHamburgerBtn" onclick="toggleSimplifiedToolbar()" title="Växla till mini-meny" style="display: none; padding: 8px 12px;">
            ☰
        </button>

        <!-- Project Selector -->
        <div class="project-selector">
            <button class="project-button" id="projectButton" onclick="toggleProjectDropdown()">
                <span id="projectName">Nytt projekt</span>
                <span>▼</span>
            </button>
            <div class="project-dropdown" id="projectDropdown">
                <div class="project-dropdown-item" onclick="renameProject()">
                    <span>✏️</span>
                    <span>Byt namn på projekt</span>
                </div>
                <div class="project-dropdown-item" onclick="createNewProject()">
                    <span>➕</span>
                    <span>Nytt projekt</span>
                </div>
                <div class="project-dropdown-item" onclick="showProjectList()">
                    <span>📂</span>
                    <span>Öppna projekt</span>
                </div>
                <div class="project-dropdown-item" onclick="manageProjects()">
                    <span>🗂️</span>
                    <span>Hantera projekt</span>
                </div>
            </div>
        </div>

        <div class="search-box">
            <input type="text" class="search-input" placeholder='Sök: "bias and social" OR "not psychology"' id="searchInput">
            <button class="search-select-btn toolbar-btn" id="searchSelectBtn" onclick="selectSearchResults()" style="display: none;">
                📍 Markera funna
            </button>
        </div>
        <div class="tag-filter-box">
            <input type="text" class="tag-filter-input" placeholder='Tags: tech AND psychology NOT done' id="tagFilterInput">
        </div>
        <button class="toolbar-btn" id="annotationToggleBtn" onclick="toggleAnnotationToolbar()" title="Aktivera/inaktivera annotation-verktyg" style="padding: 8px 16px;">
            ⬜→⭕
        </button>
        <button class="toolbar-btn" id="imageUploadBtn" onclick="triggerImageUpload()" title="Tre bildval: Kamera, Galleri, Filväljare" style="padding: 8px 16px;">
            📷 Bilder
        </button>
        <button class="toolbar-btn" id="multiImportBtn" onclick="showMultiCardPasteDialog()" title="Skapa flera kort samtidigt (M)" style="padding: 8px 16px;">
            📋 Multi-import
        </button>
        <button class="toolbar-btn" id="aiAssistantBtn" onclick="toggleAIPanel()" title="Öppna AI-assistent" style="padding: 8px 16px;">
            🤖 AI
        </button>
        <button class="toolbar-btn" id="viewToggleBtn" onclick="toggleView()" title="Växla mellan brädvy och kolumnvy" style="padding: 8px 16px;">
            📋 Kolumnvy
        </button>

        <!-- Mobile controls (hidden on desktop) -->
        <div class="mobile-controls">
            <button class="mobile-btn zoom-out-btn" onclick="zoomOutToCenter()" title="Zooma ut centralt">🔍−</button>
            <button class="mobile-btn new-card-btn" onclick="addNewCard()" title="Tap: Nytt kort | Långtryck: Kamera/Bilder">➕</button>
        </div>
        <div class="menu-dropdown">
            <button class="menu-button toolbar-btn">
                ⚙️ Meny
                <span>▼</span>
            </button>
            <div class="dropdown-content">
                <button onclick="closeMenuDropdowns(); saveBoard()">💾 Spara (LocalStorage)</button>
                <button onclick="closeMenuDropdowns(); saveWithTimestamp()">💾 Spara fil</button>
                <button onclick="closeMenuDropdowns(); saveAs()">💾 Spara som...</button>
                <button onclick="closeMenuDropdowns(); loadBoard()">📂 Ladda fil</button>
                <button onclick="closeMenuDropdowns(); exportToJSON()">📋 Exportera JSON</button>
                <button onclick="closeMenuDropdowns(); importFromJSON()">📁 Importera JSON</button>
                <button onclick="closeMenuDropdowns(); importFromExtractor()">📥 Från PDF-Extractor</button>
                <button onclick="closeMenuDropdowns(); document.getElementById('zoteroHtmlInput').click()">📚 Från Zotero</button>
                <button onclick="closeMenuDropdowns(); toggleGoogleDriveAuth()" id="googleDriveBtn">🔗 Google Drive</button>
                <button onclick="closeMenuDropdowns(); toggleMetadataView()" id="metadataBtn">🔍 Metadata</button>
                <button onclick="closeMenuDropdowns(); debugDumpPositions()">🐛 Debug Positioner</button>
                <button onclick="closeMenuDropdowns(); toggleDarkTheme()" id="themeBtn">🌙 Mörkt Tema</button>
                <button onclick="closeMenuDropdowns(); clearBoard()">🗑️ Rensa</button>
            </div>
        </div>

        <!-- Keyboard commands dropdown -->
        <div class="menu-dropdown">
            <button class="menu-button toolbar-btn">
                ⌨️
                <span>▼</span>
            </button>
            <div class="dropdown-content">
                <button onclick="closeMenuDropdowns(); executeCommand('H')">H</button>
                <button onclick="closeMenuDropdowns(); executeCommand('V')">V</button>
                <button onclick="closeMenuDropdowns(); executeCommand('G+V')">G+V</button>
                <button onclick="closeMenuDropdowns(); executeCommand('G+H')">G+H</button>
                <button onclick="closeMenuDropdowns(); executeCommand('G+T')">G+T</button>
                <button onclick="closeMenuDropdowns(); executeCommand('QQ')">QQ</button>
                <button onclick="closeMenuDropdowns(); executeCommand('Q')">Q</button>
                <button onclick="closeMenuDropdowns(); executeCommand('C')">C</button>
                <button onclick="closeMenuDropdowns(); executeCommand('T')">🎨 T</button>
                <button onclick="closeMenuDropdowns(); showSortMenu(event)">📊 Sortera</button>
                <button onclick="closeMenuDropdowns(); executeCommand('Pin')">📌 Pin</button>
                <button onclick="closeMenuDropdowns(); executeCommand('Unpin')">🔓 Unpin</button>
                <button onclick="closeMenuDropdowns(); executeCommand('Delete')">🗑️ Delete</button>
                <button onclick="closeMenuDropdowns(); executeCommand('Ctrl+Z')">Ctrl+Z</button>
                <button onclick="closeMenuDropdowns(); executeCommand('Ctrl+Y')">Ctrl+Y</button>
                <button onclick="closeMenuDropdowns(); executeCommand('Ctrl+A')">Ctrl+A</button>
                <button onclick="closeMenuDropdowns(); executeCommand('Ctrl+S')">Ctrl+S</button>
            </div>
        </div>
    </div>

    <div class="search-results-info" id="searchInfo"></div>
    <div class="selection-info" id="selectionInfo"></div>

    <!-- The invisible ruler -->
    <div id="text-ruler"></div>

    <!-- Desktop zoom-out button -->
    <button class="desktop-zoom-btn" onclick="zoomOutToCenter()" title="Zooma ut för att visa alla kort">🔍</button>

    <div id="cy"></div>

    <!-- Column view container -->
    <div id="columnView" class="column-view" style="display: none;">
        <div class="column-container" id="columnContainer">
            <!-- Column view cards will be rendered here -->
        </div>
    </div>

    <!-- Annotation Toolbar -->
    <div class="annotation-toolbar" id="annotationToolbar">
        <div class="annotation-tool-group">
            <div class="annotation-tool active" data-tool="select" title="Välj och flytta">🔍 Välj</div>
            <div class="annotation-separator"></div>
            <div class="annotation-tool" data-tool="rect" title="Rektangel">⬜</div>
            <div class="annotation-tool" data-tool="circle" title="Cirkel">⭕</div>
            <div class="annotation-tool" data-tool="triangle" title="Triangel">🔺</div>
            <div class="annotation-tool" data-tool="diamond" title="Diamant">◆</div>
            <div class="annotation-tool" data-tool="star" title="Stjärna">⭐</div>
            <div class="annotation-tool" data-tool="hexagon" title="Hexagon">⬢</div>
        </div>
        <div class="annotation-tool-group">
            <div class="annotation-tool" data-tool="text-small" title="Liten text">🅰️ S</div>
            <div class="annotation-tool" data-tool="text-medium" title="Medium text">🅰️ M</div>
            <div class="annotation-tool" data-tool="text-large" title="Stor text">🅰️ L</div>
            <div class="annotation-separator"></div>
            <div class="annotation-tool" data-tool="arrow" title="Pil mellan objekt">→</div>
            <div class="annotation-tool" data-tool="line" title="Linje mellan objekt">➖</div>
            <div class="annotation-separator"></div>
            <div class="annotation-tool" data-tool="resize" title="Aktivera storleksändring (högerklick på figur)">↗️</div>
        </div>
        <div class="annotation-tool-group">
            <div class="annotation-tool" data-tool="color-red" title="Röd färg" style="background: #ff6b6b; color: white;">●</div>
            <div class="annotation-tool" data-tool="color-blue" title="Blå färg" style="background: #4ecdc4; color: white;">●</div>
            <div class="annotation-tool" data-tool="color-green" title="Grön färg" style="background: #45b7d1; color: white;">●</div>
            <div class="annotation-tool" data-tool="color-yellow" title="Gul färg" style="background: #f9ca24; color: white;">●</div>
            <div class="annotation-tool" data-tool="color-purple" title="Lila färg" style="background: #a55eea; color: white;">●</div>
        </div>
    </div>

    <!-- Hidden file inputs for image upload -->
    <input type="file" id="hiddenCameraInput" accept="image/*" multiple capture="camera" style="display: none;">
    <input type="file" id="hiddenGalleryInput" accept="image/*" multiple style="display: none;">

    <!-- Hidden file input for Zotero HTML import -->
    <input type="file" id="zoteroHtmlInput" accept=".html" style="display: none;">

    <!-- AI Chat Panel -->
    <div class="ai-panel" id="aiPanel">
        <div class="ai-panel-header">
            <div class="ai-panel-title">🤖 AI-assistent</div>
            <button class="ai-panel-close" onclick="toggleAIPanel()">✕</button>
        </div>
        <div class="ai-panel-messages" id="aiMessages">
            <!-- Chat messages will appear here -->
        </div>
        <div class="ai-panel-input-area">
            <div class="ai-input-wrapper">
                <textarea class="ai-panel-input" id="aiPanelInput" placeholder="Fråga AI om dina anteckningar...
Exempel: Visa alla kort om projektet, Sortera todos i veckogrid" rows="2"></textarea>
                <button class="ai-panel-send" id="aiPanelSend" onclick="sendAIMessage()">Skicka</button>
            </div>
        </div>
    </div>

    <!-- Application JavaScript modules (loaded in dependency order) -->
    <script src="js/config.js"></script>
    <script src="js/globals.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/image-handler.js"></script>
    <script src="js/annotations.js"></script>
    <script src="js/search.js"></script>
    <script src="js/card-operations.js"></script>
    <script src="js/layouts.js"></script>
    <script src="js/cytoscape-init.js"></script>
    <script src="js/ai-assistant.js"></script>
    <script src="js/google-drive.js"></script>
    <script src="js/main.js"></script>
</body>
</html>
